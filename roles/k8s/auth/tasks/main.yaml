- name: Create temporary build directory
  ansible.builtin.tempfile:
    state: directory
    suffix: _k8s
  delegate_to: localhost
  register: tempfile

- name: Get configuration
  ansible.builtin.fetch:
    src: /etc/kubernetes/admin.conf
    dest: "{{ tempfile.path }}/kube_config"
    flat: yes
  become: true

- name: Location of kube_config on local node
  debug:
    msg: "{{ tempfile.path }}/kube_config"

- name: Create the token
  shell: kubeadm token create --ttl 1h --description "Generated by Ansible to add nodes"
  register: admin_token

- name: Get certificate key
  shell: cat certificate-key.pass
  register: certificate_key

# Credit: inspired from https://medium.com/@kosta709/kubernetes-by-kubeadm-config-yamls-94e2ee11244
- name: Compute CA certificate hash
  shell: "openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* /sha256:/'"
  register: ca_cert_hash

# Credit: inspired from https://stackoverflow.com/a/47811099  
- name: "Save information to a dummy host"
  add_host:
    name:   "ansible_dummy_host"
    _token:  "{{ admin_token.stdout_lines[0] }}"
    _kube_config: "{{ tempfile.path }}/kube_config"
    _ca_cert_hash:  "{{ ca_cert_hash.stdout_lines[0] }}"
    _certificate_key:  "{{ certificate_key.stdout_lines[0] }}"
    _tempdir:  "{{ tempfile.path }}"
